---
layout: 兰志远
title: js的循环机制
date: 2018-06-20 10:20:14
tags: javascript
type: "tags"
---
### 前言

大家都知道js是单线程的脚本语言，在同一时间，只能做同一件事，为了协调事件、用户交互、脚本、UI渲染和网络处理等行为，防止主线程阻塞

### 为什么js是单线程？

js作为主要是运行在浏览器的脚本语言，js主要用途之一是操作DOM

如果js同时有两个线程，同时对同一个dom进行操作，这时浏览器应该听哪一个的线程的，如何判断优先级？
为了避免这个问题，js必须是一门单线程语言

### 执行栈与任务队列

因为js是单线程语言，当遇到异步任务(如ajax操作时)，不可能一直等待异步任务完成，在继续往下执行，在这期间浏览器是空闲状态，显而易见这会导致巨大的资源浪费。

### 执行栈

当执行某个函数、用户点击一次鼠标，ajax完成，一个图片加载完成等事件发生时，只要指定过回调函数，这些事件发生就会进入执行栈队列中，等待主线程读取，遵循先进先出原则。

### 主线程

要明确的一点是，主线程跟执行栈是不同概念，主线程规定现在执行执行栈中的哪个时间。

主线程循环：主线程会不停的从执行栈中读取时间，会执行完所有栈中的同步代码。
当遇到一个异步事件后，并不会一直等待异步事件返回结果，而是会将这个事件挂在与执行栈不同的队列中，我们称之为任务队列(Task Queue)。
当主线程将执行栈中所有的代码执行完之后，主线程将会去查看任务队列是否有任务，如果有，那么主线程会依次执行那些任务队列中的回调函数。

### js异步执行的运行机制
* 1.所有任务都在主线程上执行，形成一个执行栈
* 2.主线程之外，还存在一个'任务队列'(Task Queue)，只要异步任务有了运行结果，就在'任务队列'中放置一个事件
* 3.一旦'执行栈'中的所有同步任务执行完毕，系统就会读取'任务队列'，那些对应的任务结束等待状态，进入执行栈并开始执行
* 4.主线程不断重复上面的第三步

### 事件循环需要记住以下几点:
* 事件队列严格按照时间先后顺序将任务压入执行栈执行
* 当执行栈为空时，浏览器会一直不停的检查事件队列，如果不为空，则取出第一个任务
* 在每一个任务结束之后，浏览器会对页面进行渲染